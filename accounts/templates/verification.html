{% extends 'base.html' %}
{% block content %}
<h2>Live Verification</h2>

<button onclick="startVideoStreams()">Start Camera</button>

<div style="display: flex; flex-direction: column; gap: 16px;">
  <label>ID Document Scan</label>
  <video id="idPreview" autoplay playsinline muted></video>
  <button type="button" onclick="captureID()">Capture ID</button>
  <p id="idStatus" style="color: green; display: none;">✅ ID Captured</p>

  <label>Face Scan</label>
  <video id="facePreview" autoplay playsinline muted></video>
  <button type="button" onclick="captureFace()">Capture Face</button>
  <p id="faceStatus" style="color: green; display: none;">✅ Face Captured</p>
</div>

<div id="spinner" style="display:none;">
  <p>Processing verification...</p>
</div>

<form method="post">
  {% csrf_token %}
  <input type="hidden" name="id_image" id="idImageField">
  <input type="hidden" name="face_image" id="faceImageField">
  <button type="submit" id="submitBtn" disabled>Verify Now</button>
</form>

<script>
let idStream, faceStream;

async function startVideoStreams() {
  try {
    const idStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }
    });
    document.getElementById("idPreview").srcObject = idStream;
  } catch (e) {
    console.warn("Back camera not available, using default for ID.");
    const fallback = await navigator.mediaDevices.getUserMedia({ video: true });
    document.getElementById("idPreview").srcObject = fallback;
  }

  try {
    const faceStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" }
    });
    document.getElementById("facePreview").srcObject = faceStream;
  } catch (e) {
    console.warn("Front camera not available, using default for Face.");
    const fallback = await navigator.mediaDevices.getUserMedia({ video: true });
    document.getElementById("facePreview").srcObject = fallback;
  }
}

startVideoStreams();

function captureFrame(video) {
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);
  return canvas.toDataURL("image/jpeg");
}

function showToast(message) {
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: #4caf50; color: white; padding: 10px 20px; border-radius: 8px;
    z-index: 1000; opacity: 0.95; font-weight: bold;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2000);
}

function captureID() {
  const frame = captureFrame(document.getElementById("idPreview"));
  document.getElementById("idImageField").value = frame;
  showToast("✅ ID captured!");
}

function captureFace() {
  const frame = captureFrame(document.getElementById("facePreview"));
  document.getElementById("faceImageField").value = frame;
  showToast("✅ Face captured!");
}

document.querySelector("form").onsubmit = function () {
  document.getElementById("spinner").style.display = "block";
};
</script>
{% endblock %}
