{% extends 'base.html' %}
{% block content %}
<h2>Live Verification</h2>

<div style="display: flex; flex-direction: column; gap: 16px;">
  <label>ID Document</label>
  <video id="idPreview" autoplay playsinline muted></video>
  <button onclick="captureID()">ğŸ“¸ Capture ID</button>

  <label>Face Scan</label>
  <video id="facePreview" autoplay playsinline muted></video>
  <button onclick="captureFace()">ğŸ“¸ Capture Face</button>

  <button onclick="toggleCamera()">ğŸ” Switch Camera</button>
</div>

<div id="spinner" style="display:none;">
  <p>â³ Processing verification...</p>
</div>

<form method="post">
  {% csrf_token %}
  <input type="hidden" name="id_image" id="idImageField">
  <input type="hidden" name="face_image" id="faceImageField">
  <button type="submit">âœ… Verify Now</button>
</form>

<script>
let videoTracks = [];
let currentFacingMode = 'environment';

async function setupCamera(videoElement, facingMode) {
  if (videoTracks.length) {
    videoTracks.forEach(track => track.stop());
  }

  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: facingMode }
  });

  videoElement.srcObject = stream;
  videoTracks = stream.getVideoTracks();
  currentFacingMode = facingMode;
}

function captureFrame(video) {
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);
  return canvas.toDataURL("image/jpeg");
}

function captureID() {
  document.getElementById("idImageField").value = captureFrame(document.getElementById("idPreview"));
  alert("âœ… ID captured!");
}

function captureFace() {
  document.getElementById("faceImageField").value = captureFrame(document.getElementById("facePreview"));
  alert("âœ… Face captured!");
}

async function toggleCamera() {
  const newMode = currentFacingMode === 'environment' ? 'user' : 'environment';
  setupCamera(document.getElementById("idPreview"), newMode);
  setupCamera(document.getElementById("facePreview"), newMode);
}

document.querySelector("form").onsubmit = function () {
  document.getElementById("spinner").style.display = "block";
};

window.onload = () => {
  setupCamera(document.getElementById("idPreview"), 'environment');
  setupCamera(document.getElementById("facePreview"), 'user');
};
</script>
{% endblock %}
